<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3.2 Plain OpenID 2.0-RC2</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction to the Spring Security OpenID Plugin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/usage.html"><strong>2</strong><span>Usage</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/tutorials.html"><strong>3</strong><span>Tutorials</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/configuration.html"><strong>4</strong><span>Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/attributeExchange.html"><strong>5</strong><span>Attribute Exchange</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>OpenID authentication support for the Spring Security plugin.</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/usage.html">&lt;&lt; <strong>2</strong><span>Usage</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/configuration.html"><strong>4</strong><span>Configuration</span> >></a></div>
                


                <div class="project">
                    <h1>3.2 Plain OpenID - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Burt Beckwith</p>

                    <p><strong>Version:</strong> 2.0-RC2</p>

                    
                </div>

                

                

<h2 id="plainOpenid">3.2 Plain OpenID</h2>
In the previous tutorial we went through two workflows to allow linking OpenIDs to local accounts. Another option is to only support OpenID logins but not associate them with local accounts. This might be useful if you want to allow people to perform some basic actions like clicking Like and Don't Like buttons, adding comments, etc.<p class="paragraph"/>To support this, rather than showing the registration page when an authenticated OpenID user is redirected to your controller, you could just create an <code>Authentication</code> for them with dummy information. Recall that the minimum requirements to populate a <code>UserDetails</code> instance are the username, the status booleans (enabled, locked out, etc.) and one or more granted authorities. You could emulate a basic application user by using their OpenID as the username, setting all statuses to <code>true</code>, and granting them a virtual role, e.g. <code>ROLE_OPENID</code>.<p class="paragraph"/>Copy the plugin's <code>grails.plugin.springsecurity.openid.OpenIdController.groovy</code> to your application's grails-app/controllers directory and replace the existing <code>createAccount</code> action with this:<p class="paragraph"/><div class="code"><pre>def createAccount() &#123;<p class="paragraph"/>   def config = SpringSecurityUtils.securityConfig<p class="paragraph"/>   <span class="java&#45;object">String</span> openId = session&#91;OpenIdAuthenticationFailureHandler.LAST_OPENID_USERNAME&#93;
   <span class="java&#45;keyword">if</span> (!openId) &#123;
      flash.error = 'Sorry, an OpenID was not found'
      redirect uri: config.failureHandler.defaultFailureUrl
      <span class="java&#45;keyword">return</span>
   &#125;<p class="paragraph"/>   def user = <span class="java&#45;keyword">new</span> GrailsUser(openId, 'password', <span class="java&#45;keyword">true</span>, <span class="java&#45;keyword">true</span>,
         <span class="java&#45;keyword">true</span>, <span class="java&#45;keyword">true</span>, &#91;<span class="java&#45;keyword">new</span> SimpleGrantedAuthority('ROLE_OPENID')&#93;, 0)<p class="paragraph"/>   SCH.context.authentication = <span class="java&#45;keyword">new</span> UsernamePasswordAuthenticationToken(
         user, 'password', user.authorities)<p class="paragraph"/>   session.removeAttribute OpenIdAuthenticationFailureHandler.LAST_OPENID_USERNAME
   session.removeAttribute OpenIdAuthenticationFailureHandler.LAST_OPENID_ATTRIBUTES<p class="paragraph"/>   def savedRequest = requestCache.getRequest(request, response)
   <span class="java&#45;keyword">if</span> (savedRequest &#38;&#38; !config.successHandler.alwaysUseDefault) &#123;
      redirect url: savedRequest.redirectUrl
   &#125;
   <span class="java&#45;keyword">else</span> &#123;
      redirect uri: config.successHandler.defaultTargetUrl
   &#125;
&#125;</pre></div><p class="paragraph"/>You'll need to add these imports:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.userdetails.GrailsUser
<span class="java&#45;keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority
<span class="java&#45;keyword">import</span> org.springframework.security.core.context.SecurityContextHolder as SCH</pre></div><p class="paragraph"/>To test this, add a new action to the secure controller that requires the virtual <code>ROLE_OPENID</code> role:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> openidtest<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.annotation.Secured<p class="paragraph"/>class SecureController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN'&#93;)
   def admins() &#123;
      render 'Logged in with ROLE_ADMIN'
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_USER'&#93;)
   def users() &#123;
      render 'Logged in with ROLE_USER'
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_OPENID'&#93;)
   def openid() &#123;
      render 'Logged in with ROLE_OPENID'
   &#125;
&#125;</pre></div><p class="paragraph"/>Then start the server with <code>grails run-app</code> and navigate to <a href="http://localhost:8080/openidtest/secure/openid" target="blank">http://localhost:8080/openidtest/secure/openid</a>, and login using any OpenID. Once you authenticate and get redirected back to your application you should see the text <code>Logged in with ROLE_OPENID</code> indicating that you're logged in as a basic OpenID user.<p class="paragraph"/>Note that since this is a fake role, there's no need to store it in the database since real application users will never be granted ROLE_OPENID.



                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/usage.html">&lt;&lt; <strong>2</strong><span>Usage</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/configuration.html"><strong>4</strong><span>Configuration</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Scripts</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../../ref/Scripts/s2-create-openid.html">s2-create-openid</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>


<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
